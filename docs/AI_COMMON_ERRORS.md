# AI Common Errors (Do Not Do)

Этот файл — шпаргалка для агента: что **не делать** при работе с репозиторием.
Он не заменяет CANON/AGENTS/DOCS_INDEX и не меняет порядок чтения.

## Архитектура и контракты
- Не делать прямых вызовов между plane‑модулями (только EventBus).
- Не использовать `Date.now()`/wall‑clock в бизнес‑логике и агрегации (только `event.meta.ts`).
- Не ломать разделение raw/agg (raw без quality‑полей, agg — только внутренние агрегаты).
- Не использовать прямые цены биржи, если уже есть `market:price_canonical`.
- Не добавлять новые topics без BotEventMap и контрактов.

## Типобезопасность
- Не использовать `as any` или `marketType as KnownMarketType`.
- Если `marketType === 'unknown'`, не эмитить нормализованные события.
- Не отправлять неполные payload’ы (особенно `market:kline`).

## Детерминизм и replay
- Не менять порядок сортировок/приоритета причин без тестов.
- Не вносить недетерминированные источники времени/случайности в агрегаторы.
- Любые изменения в пайплайне должны проходить replay‑тесты.

## Подписки и стриминг
- Не дублировать subscribe на открытом сокете.
- После reconnect делать reconcile желаемых/активных подписок.
- Не игнорировать gap/out‑of‑order; требуется resync‑контракт.

## Логи и обсервабилити
- Не увеличивать спам в консоль без троттлинга.
- Ошибки должны быть видимы и не молчаливыми.
- Логи должны сохранять correlationId и runId (где применимо).

## Документация и тесты
- Не менять архитектурное поведение без обновления docs.
- Не удалять тесты «чтобы прошёл билд».
- Если подход провалился — зафиксировать в `docs/DECISIONS.md`.
