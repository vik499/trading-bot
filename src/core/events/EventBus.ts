import EventEmitter from 'eventemitter3';

// ============================================================================
// EventBus
// ----------------------------------------------------------------------------
// Централизованный брокер событий для всего торгового бота.
// Позволяет модулям обмениваться сообщениями без прямых зависимостей.
//
// ВАЖНО:
// - Сюда летят "нормализованные" события (наши собственные типы),
//   а не сырые ответы Bybit.
// - Это основа для масштабирования: MarketStore, Analytics, Strategy и т.д.
// ============================================================================

// ---------------------------------------------------------------------------
// Нормализованное событие "тикер" (market:ticker)
//
// Мы сознательно НЕ тащим сюда Bybit-специфичные структуры/названия.
// Внутри бота мы работаем со стабильным контрактом.
// ---------------------------------------------------------------------------
export interface TickerEvent {
    // Символ рынка (например BTCUSDT)
    symbol: string;

    // Цена последней сделки/обновления (строка, потому что Bybit присылает числа как строки)
    lastPrice?: string;

    // Mark price (цена маркировки, важна для деривативов)
    markPrice?: string;

    // Index price (индексная цена)
    indexPrice?: string;

    // Изменение за 24 часа (доля), например "-0.021485" ≈ -2.1485%
    price24hPcnt?: string;

    // Максимум/минимум за 24 часа
    highPrice24h?: string;
    lowPrice24h?: string;

    // Объём и оборот за 24 часа
    volume24h?: string;
    turnover24h?: string;

    // Биржевой timestamp сообщения (если доступен)
    ts?: number;
}

// ---------------------------------------------------------------------------
// Карта всех событий бота. Расширяем по мере развития системы.
// ---------------------------------------------------------------------------
export type BotEventMap = {
    'market:ticker': (event: TickerEvent) => void;
};

// Типизированный EventBus (EventEmitter3 поддерживает generic map)
class EventBus extends EventEmitter<BotEventMap> {}

export const eventBus = new EventBus();